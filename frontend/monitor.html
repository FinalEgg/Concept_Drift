<!-- frontend/monitor.html -->
<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>设备监控</title>
        <link rel="stylesheet" href="/static/css/monitor.css">
        <link rel="stylesheet" href="/static/css/auth.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js"></script>
        <script src="https://cdn.staticfile.org/echarts/5.3.2/echarts.min.js"></script>
    </head>
    <body>
        <div id="app">
            <div class="monitor-container" v-if="device">
                <!-- 设备标题和基本信息 -->
                <div class="device-header">
                    <h1>{{ device.name }}</h1>
                    <div class="device-info">
                        <div class="device-info-item">设备ID: {{ device.id }}</div>
                        <div class="device-info-item">IP地址: {{ device.ip }}</div>
                        <div class="device-info-item">端口: {{ device.port }}</div>
                        <div class="device-info-item">状态: {{ deviceStatus }}</div>
                    </div>
                    <!-- 操作按钮：连接/中断连接 -->
                    <button class="auth-btn" v-if="deviceStatus==='离线'" @click="connectDevice">连接设备</button>
                    <button class="auth-btn" v-else @click="disconnectDevice('手动断开')">中断连接</button>
                    <!-- 反馈信息 -->
                    <div v-if="feedbackMessage" style="margin-top: 10px; color: #f44336;">
                        {{ feedbackMessage }}
                    </div>
                    <!-- 新增：编辑和删除按钮 -->
                    <div class="device-actions" style="margin-top:10px;">
                        <button class="auth-btn" @click="editDevice">编辑设备</button>
                        <button class="auth-btn" @click="deleteDevice">删除设备</button>
                    </div>
                </div>
                
                <!-- 概念偏移图表 -->
                <div class="chart-container" ref="chartContainer"></div>
                
                <!-- 数据表格 -->
                <div class="data-table">
                    <div class="table-scroll-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th v-for="(header, index) in tableHeaders" :key="index">{{ header }}</th>
                                   </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, rowIndex) in tableData" :key="rowIndex">
                                    <td>{{ row.timestamp }}</td>
                                    <td v-for="(header, colIndex) in tableHeaders" :key="colIndex">{{ row.values[colIndex] }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            <div v-else class="loading">
                加载设备信息...
            </div>
        </div>

        <script>
            new Vue({
                el: '#app',
                data: {
                    device: null,
                    chartInstance: null,
                    chartData: [],
                    tableData: [],
                    tableHeaders: [],
                    deviceStatus: '离线',
                    feedbackMessage: '',
                    dataTimer: null,
                    realDataTimer: null
                },
                mounted() {
                    // 从父窗口接收设备信息
                    window.addEventListener('message', (event) => {
                        if (event.data.type === 'device-info') {
                            this.device = event.data.device;
                            // 初始化图表和表格（此时不填充任何模拟数据）
                            this.$nextTick(() => {
                                this.initChart();
                                this.fetchDeviceModel();
                            });
                        }
                    });
                },
                beforeDestroy() {
                    if (this.dataTimer) clearInterval(this.dataTimer);
                    if (this.realDataTimer) clearInterval(this.realDataTimer);
                    if (this.chartInstance) this.chartInstance.dispose();
                },
                methods: {
                    // 初始化 ECharts 图表接口（图表数据后续实时更新时再填充）
                    initChart() {
                        const chartDom = this.$refs.chartContainer;
                        this.chartInstance = echarts.init(chartDom);
                        const option = {
                            title: { text: '概念偏移指数监控', left: 'center' },
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    const param = params[0];
                                    return `${param.axisValue}<br />${param.marker}偏移指数：${param.data.toFixed(4)}`;
                                }
                            },
                            xAxis: {
                                type: 'time',
                                name: '时间',
                                axisLabel: { formatter: '{HH}:{mm}:{ss}' }
                            },
                            yAxis: { type: 'value', name: '概念偏移指数', min: 0, max: 1 },
                            dataZoom: [
                                { type: 'inside', start: 0, end: 100 },
                                { start: 0, end: 100 }
                            ],
                            series: [{
                                name: '偏移指数',
                                type: 'line',
                                smooth: true,
                                symbol: 'none',
                                areaStyle: { opacity: 0.3 },
                                data: []
                            }]
                        };
                        this.chartInstance.setOption(option);
                        // 不再启动模拟数据（startFetchingData 被移除）
                    },
                    // 根据设备信息构建表格表头：设备维度个数 +1 列“标签”，并清空表格数据
                    async fetchDeviceModel() {
                        const dims = this.device && this.device.dim ? parseInt(this.device.dim) : 0;
                        this.tableHeaders = dims > 0 ? Array.from({ length: dims }, (_, i) => `维度 ${i + 1}`) : [];
                        this.tableHeaders.push("标签");
                        this.tableData = [];
                    },
                    // 连接设备：调用后端 API（利用 ConnectionManager）尝试连接，连接成功后启动接收真实数据
                    connectDevice() {
                        if (!this.device) return;
                        const url = `/api/monitor/connect?ip=${this.device.ip}&port=${this.device.port}`;
                        this.eventSource = new EventSource(url);
                        this.eventSource.onopen = () => {
                            this.deviceStatus = '在线';
                            this.feedbackMessage = '连接成功';
                            alert('连接成功');
                            console.log('连接成功');
                        };
                        this.eventSource.onmessage = (event) => {
                            const messageData = event.data;
                            // 以下处理数据的逻辑
                            const dataArr = messageData.trim().split(',');
                            if (dataArr.length < 1) return;
                            const driftIndex = parseFloat(dataArr[0]);
                            const now = new Date();
                            this.chartData.push([now.getTime(), driftIndex]);
                            if (this.chartData.length > 100) this.chartData.shift();
                            this.updateChart();
                            const values = dataArr.slice(1).map(v => parseFloat(v).toFixed(4));
                            this.tableData.push({
                                timestamp: now.toLocaleTimeString(),
                                values: values
                            });
                            if (this.tableData.length > 100) this.tableData.shift();
                        };
                        this.eventSource.onerror = (error) => {
                            console.error("连接出错：", error);
                            this.disconnectDevice("连接错误");
                        };
                    },
                    // 中断连接，停止实时数据接收，并清空图表和表格
                    // 可接受一个断连原因，用于提示用户具体断连原因
                    disconnectDevice(reason) {
                        if (this.eventSource) {
                            this.eventSource.close();
                            this.eventSource = null;
                        }
                        this.deviceStatus = '离线';
                        this.feedbackMessage = reason || '连接已中断';
                        console.log('断开连接: ' + (reason || '手动断开'));
                        alert(reason || '连接已中断');
                        // 清空数据，使界面恢复空状态
                        this.chartData = [];
                        this.tableData = [];
                        if (this.chartInstance) {
                            this.chartInstance.setOption({ series: [{ data: [] }] });
                        }
                    },
                    // 接收真实数据更新图表和表格（保留接收 simulation 设备数据展示的功能）
                    startFetchingRealData() {
                        const url = `/api/monitor/connect?ip=${this.device.ip}&port=${this.device.port}`;
                        this.eventSource = new EventSource(url);
                        this.eventSource.onmessage = (event) => {
                            const messageData = event.data;
                            // 假设后端传来的数据为以逗号分隔的数值字符串，
                            // 第一项为偏移指数，后续为设备的数据（特征及标签）
                            const dataArr = messageData.trim().split(',');
                            if (dataArr.length < 1) return;
                            const driftIndex = parseFloat(dataArr[0]);
                            const now = new Date();
                            // 更新图表数据
                            this.chartData.push([now.getTime(), driftIndex]);
                            if (this.chartData.length > 100) this.chartData.shift();
                            this.updateChart();
                            // 更新表格数据，取除第一项之外的数据
                            const values = dataArr.slice(1).map(v => parseFloat(v).toFixed(4));
                            this.tableData.push({
                                timestamp: now.toLocaleTimeString(),
                                values: values
                            });
                            if (this.tableData.length > 100) this.tableData.shift();
                        };
                        this.eventSource.onerror = (error) => {
                            console.error("接收数据出错：", error);
                            this.disconnectDevice("连接断开");
                        };
                    },
                    updateChart() {
                        if (this.chartInstance) {
                            const seriesData = this.chartData.map(item => ({
                                name: new Date(item[0]).toLocaleTimeString(),
                                value: [item[0], item[1]]
                            }));
                            this.chartInstance.setOption({ series: [{ data: seriesData }] });
                        }
                    },
                    // 编辑设备：跳转到编辑页面，页面将预填设备当前信息（通过 URL 参数传递 device.id）
                    editDevice() {
                        if (!this.device) return;
                        window.location.href = `/device_edit/${this.device.id}`;
                    },
                    // 删除设备：确认后调用后端删除接口，并通过postMessage通知dashboard更新侧边栏
                    deleteDevice() {
                        if (!this.device) return;
                        if (confirm("确定要删除该设备吗？删除后该设备将从系统中移除。")) {
                            // 假设后端提供 /api/devices/delete 接口，使用 POST 方法提交设备 id
                            fetch('/api/devices/delete', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ deviceId: this.device.id })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("设备已删除");
                                    // 通过 postMessage 通知上级 dashboard 更新设备侧边栏
                                    window.parent.postMessage({ type: 'device-deleted', deviceId: this.device.id }, '*');
                                    // 修改为让父窗口直接跳转到dashboard，避免内嵌dashboard页面出现
                                    window.parent.location.href = '/dashboard.html';
                                } else {
                                    alert(data.message || "删除设备失败");
                                }
                            })
                            .catch(err => {
                                console.error('删除设备请求错误:', err);
                                alert("删除设备请求错误");
                            });
                        }
                    }
                }
            });
        </script>
    </body>
</html>