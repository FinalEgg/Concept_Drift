<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建数据模型</title>
    <link rel="stylesheet" href="static/css/auth.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
</head>
<body>
    <div id="app">
        <div class="auth-container">
            <div class="auth-box">
                <h2 class="auth-title">创建新数据模型</h2>
                <form @submit.prevent="handleCreateModel">
                    <div class="form-group">
                        <label for="modelName">模型名称</label>
                        <input type="text" id="modelName" v-model="modelName" required>
                    </div>

                    <div class="form-group">
                        <label for="dimension">数据维度</label>
                        <input type="number" id="dimension" v-model.number="dimension" 
                               min="1" max="10" @change="updateDimensions" required>
                    </div>

                    <!-- 动态生成的数据类型选择框 -->
                    <div class="data-types-container">
                        <div v-for="(type, index) in dataTypes" :key="index" class="form-group">
                            <label :for="'dataType' + index">维度 {{ index + 1 }} 的数据类型</label>
                            <select :id="'dataType' + index" v-model="dataTypes[index]" required>
                                <option value="int">整数</option>
                                <option value="float">浮点数</option>
                                <option value="bool">布尔值</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="auth-btn">创建模型</button>

                    <div class="error-message" v-if="errorMessage">
                        {{ errorMessage }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                modelName: '',
                dimension: 1,
                dataTypes: ['float'],
                errorMessage: ''
            },
            methods: {
                updateDimensions() {
                    const oldLength = this.dataTypes.length;
                    const newLength = this.dimension;
                    
                    if (newLength > oldLength) {
                        for (let i = oldLength; i < newLength; i++) {
                            this.dataTypes.push('float');
                        }
                    } else if (newLength < oldLength) {
                        this.dataTypes.splice(newLength);
                    }
                },
                
                async handleCreateModel() {
                    try {
                        const response = await fetch('/api/models/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                modelName: this.modelName,
                                dimension: this.dimension,
                                dataTypes: this.dataTypes
                            })
                        });
    
                        const data = await response.json();
                        if (data.success) {
                            // 获取父页面中的 main-view 内嵌 iframe
                            const mainIframe = window.parent.document.querySelector('.main-view iframe');
                            if (mainIframe) {
                                const pendingDevice = localStorage.getItem('pendingDevice');
                                if (pendingDevice) {
                                    localStorage.removeItem('pendingDevice');
                                    mainIframe.src = '/add-device';
                                } else {
                                    // 若无待处理设备，切换回默认欢迎视图，清空 iframe 内容
                                    mainIframe.src = 'about:blank';
                                }
                            }
                        } else {
                            this.errorMessage = data.message || '创建模型失败';
                        }
                    } catch (error) {
                        console.error('创建模型失败:', error);
                        this.errorMessage = '服务器错误，请稍后重试';
                    }
                }
            }
        });
    </script>
</body>
</html>